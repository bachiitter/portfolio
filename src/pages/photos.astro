---
  export const prerender = false;

  import { PHOTOS_API_TOKEN, PHOTOS_API_URL } from "astro:env/server";
  import Lightbox from "../components/Lightbox.astro";
  import PhotoCard from "../components/PhotoCard.astro";
  import BaseLayout from "../layouts/BaseLayout.astro";
  import { type Photo } from "../lib/loaders/photos";

  function buildHeaders(etag?: string): HeadersInit {
    const headers: HeadersInit = {
      "Content-Type": "application/json",
    };

    headers.Authorization = `Bearer ${PHOTOS_API_TOKEN}`;

    if (etag) {
      headers["If-None-Match"] = etag;
    }

    return headers;
  }

  async function fetchAllPhotos(): Promise<Photo[]> {
    const allPhotos: Photo[] = [];
    let currentPage = 1;
    let hasMore = true;
    const limit = 100;

    while (hasMore) {
      const url = `${PHOTOS_API_URL}?page=${currentPage}&limit=${limit}&sort=desc`;
      const response = await fetch(url, {
        headers: buildHeaders(),
      });

      if (response.status === 429) {
        throw new Error("Rate limit exceeded. Please try again later.");
      }

      if (response.status === 401) {
        throw new Error("Unauthorized. Check your API token.");
      }

      if (!response.ok) {
        throw new Error(`Failed to fetch photos: ${response.status} ${response.statusText}`);
      }

      const data = await response.json();

      if (!data.photos || !Array.isArray(data.photos)) {
        throw new Error("Invalid API response format");
      }

      allPhotos.push(...data.photos);

      hasMore = data.pagination?.hasNext || false;
      currentPage++;
    }

    return allPhotos;
  }

  Astro.response.headers.set("Cache-Control", "public, max-age=3600");

  const photos = await fetchAllPhotos();

  // const { entries: photos } = await getLiveCollection("photos");
  const col1 = photos?.filter((_, i) => i % 2 === 0);
  const col2 = photos?.filter((_, i) => i % 2 === 1);
---
<BaseLayout title="Photos" description="Random dump of unedited photos.">
  <section>
    <h2 class="font-mono text-xs font-medium uppercase tracking-wider text-tertiary mb-6">
      Photos
    </h2>
    {photos && photos.length > 0 ? (
      <>
        {/* Mobile View: Sequential */}
        <div class="flex flex-col gap-4 xs:hidden">
          {photos.map((photo, index: number) => (
            <PhotoCard photo={photo} index={index} />
          ))}
        </div>

        {/* Desktop View: Masonry Split (1-2, 3-4 ordering visual) */}
        <div class="hidden xs:grid xs:grid-cols-2 gap-4 items-start">
          <div class="flex flex-col gap-4">
            {col1?.map(( photo , index: number) => (
              <PhotoCard photo={photo} index={index * 2} />
            ))}
          </div>
          <div class="flex flex-col gap-4">
            {col2?.map((photo , index: number) => (
              <PhotoCard photo={photo} index={index * 2 + 1} />
            ))}
          </div>
        </div>
      </>
    ) : (
      <div class="py-12 text-center">
        <div class="text-tertiary font-mono text-sm mb-2">No photos yet</div>
        <p class="text-secondary text-sm">Photo gallery will appear here</p>
      </div>
    )}
  </section>
  <Lightbox/>
</BaseLayout>
